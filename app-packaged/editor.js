var pxt;!function(g){!function(e){var o=pxtc.UF2,l=1024,i=256;var t,n,a=function(){function e(r){this.packetIo=r;var t=new g.U.PromiseBuffer,e=function(e){return r.talksAsync(e.map(function(e){return{cmd:0,data:e}}))};r.talksAsync||(e=null);var n=new DapJS.DAP({write:function(e){return r.sendPacketAsync(new Uint8Array(e))},close:this.disconnectAsync,read:function(){return t.shiftAsync()},sendMany:e});this.cortexM=new DapJS.CortexM(n),r.onData=function(e){t.push(e)}}return e.prototype.reconnectAsync=function(e){var r=this;return e?this.cortexM.init():this.packetIo.reconnectAsync().then(function(){return r.cortexM.init()})},e.prototype.disconnectAsync=function(){return this.packetIo.disconnectAsync()},e}();function r(){return n?Promise.resolve(n):Promise.resolve().then(function(){return n?n.disconnectAsync().finally(function(){n=null}):Promise.resolve()}).then(function(){return t?t.then(function(e){return(r=e).reconnectAsync()}).then(function(){return r}):t=g.HF2.mkPacketIOAsync().catch(function(e){return t=null,Promise.reject(e)});var r}).then(function(e){var r=new a(e);return(n=r).reconnectAsync(!0).then(function(){return r})})}function c(){var e=!1;if(g.usb.isEnabled)e=!0;else if(g.U.isNodeJS)e=!0;else{var r=/forceHexDownload/i.test(window.location.href),t=!!window.Windows;(g.Cloud.isLocalHost()&&g.Cloud.localToken&&!r||t)&&(e=!0)}return e}new Uint32Array([3187719680,612414960,14951168,1489852610,3506651818,1117991684,3186676216,1259742466,1352485398,754997533,614584572,1360527588,1023360009,1495138341,3506187776,1352410112,738220380,604098812,1352410496,1499201773,3506187264,15541632,3023872,1359436047,788552031,872730876,3522642604,1352212736,704666010,3889221884,1073864704,1284]);var s=new Uint32Array([3187719680,604157424,1243040534,612389020,2425060,771774750,614584572,1360527588,738220380,604033276,612389020,2425060,771774750,604098812,1499222172,3506187264,15541632,3023872,1359436047,788552031,872730876,3522642604,1352212736,704666010,3186675964,1073864704,1284]),d=new Uint32Array([1277670896,1151673984,570462721,2432716581,7770883,604504083,620822553,1089159209,3489671424,1006715003,3522505728,1183580305,2835629669,1349202433,3521856178,144415489,588485378,2600683164,3506717340,536919594,1151159061,2667625968,1293196802,1226131988,1040305928,554779467,1225998795,1079657291,1180909661,587547098,1259357018,1180899538,587547101,1259160413,771758317,1610797543,2583730945,416505925,2466263048,3889312769,4294966252,3988292384,1044,516138696,798746316,3432918353,461845907,3864292196]),f=0;function m(e){var r=Date.now();f||(f=r);var t=("00000"+(r-=f)).slice(-5);g.log("HID "+t+": "+e)}var h=536870912,v=536879104,y=536875008;function A(e,i){return e.filter(function(e){var r=e.targetAddr/l;if(g.U.assert((0|r)==r),g.U.assert(e.data.length==l),8*r+8>i.length)return!0;var t=g.HF2.read32(i,8*r),n=g.HF2.read32(i,8*r+4),o=function(e){for(var r=798746316,t=516138696,n=0;n<e.length;n+=4){var o=g.HF2.read32(e,n)>>>0;o=(o=Math.imul(o,3432918353))<<15|o>>>17,r=(r^=o=Math.imul(o,461845907))<<13|r>>>19,t=(t^=o)<<13|t>>>19,r=Math.imul(r,5)+3864292196>>>0,t=Math.imul(t,5)+3864292196>>>0}return[r,t]}(e.data);return t!=o[0]||n!=o[1]})}function u(t){var u;f=0,m("init");var n;return g.tickEvent("hid.flash.start"),(c()?r():Promise.reject(new Error("no HID"))).then(function(e){return u=e,m("reset"),u.cortexM.reset(!0).catch(function(e){return m("trying re-connect"),u.reconnectAsync(!1).then(function(){return u.cortexM.reset(!0)})})}).then(function(){return u.cortexM.memory.readBlock(268439572,1,l)}).then(function(e){245760!=g.HF2.read32(e,0)&&(g.tickEvent("hid.flash.uicrfail"),g.U.userError(g.U.lf("Please flash any MakeCode hex file using drag and drop. Flashing from app will work afterwards.")))}).then(function(){return function(e){m("getting existing flash checksums");var r=i;return e.cortexM.runCode(d,h,h+1,4294967295,y,!0,v,0,l,r).then(function(){return e.cortexM.memory.readBlock(v,2*r,l)})}(u)}).then(function(e){return n=e,m("write code"),u.cortexM.memory.writeBlock(h,s)}).then(function(){m("convert");var e=o.newBlockFile();o.writeHex(e,t.outfiles[pxtc.BINARY_HEX].split(/\r?\n/));var r=g.U.stringToUint8Array(o.serializeFile(e)),c=function(e,r){g.U.assert(r%256==0);for(var t=[],n=0;n<e.length;){for(var o=e[n],i=new Uint8Array(r),a=o.targetAddr&r-1,c=o.targetAddr-a;n<e.length;++n){var u=e[n];if(u.targetAddr+u.payloadSize>c+r)break;g.U.memcpy(i,u.targetAddr-c,u.data,0,u.payloadSize)}var l=g.U.flatClone(o);l.data=i,l.targetAddr=c,l.payloadSize=r,t.push(l)}return t}(o.parseFile(r),l);return m("initial: "+c.length+" pages"),m("incremental: "+(c=A(c,n)).length+" pages"),Promise.mapSeries(g.U.range(c.length),function(t){var n=c[t];if(268435456<=n.targetAddr)return Promise.resolve();n.targetAddr.toString(16);var e=Promise.resolve(),o=1&t?v:v+l,i=1&t?v+l:v;if(0==t){for(var r=new Uint32Array(n.data.length/4),a=0;a<n.data.length;a+=4)r[a>>2]=g.HF2.read32(n.data,a);e=u.cortexM.memory.writeBlock(o,r)}return e.then(function(){return e=n,r=o,(t=u.cortexM.prepareCommand()).halt(),t.writeCoreRegister(15,h+4+1),t.writeCoreRegister(14,h+1),t.writeCoreRegister(13,y),t.writeCoreRegister(0,e.targetAddr),t.writeCoreRegister(1,r),Promise.resolve().then(function(){return t.go()}).then(function(){return u.cortexM.debug.enable()});var e,r,t}).then(function(){var e=c[t+1];if(!e)return Promise.resolve();var r=new Uint32Array(e.data.buffer);return u.cortexM.memory.writeBlock(i,r)}).then(function(){return u.cortexM.waitForHalt(500)}).then(function(){})}).then(function(){return m("flash done"),g.tickEvent("hid.flash.done"),u.cortexM.reset(!1)})}).catch(function(e){return"devicenotfound"===e.type?void g.tickEvent("hid.flash.devicenotfound"):g.commands.saveOnlyAsync(t)})}function p(e,r){if(!(0<=g.semver.majorCmp(e||"0.0.0","1.0.0"))){g.U.toArray(r.querySelectorAll("block[type=device_show_leds]")).concat(g.U.toArray(r.querySelectorAll("block[type=device_build_image]"))).concat(g.U.toArray(r.querySelectorAll("block[type=device_build_big_image]"))).forEach(function(e){var o=[[],[],[],[],[]];g.U.toArray(e.querySelectorAll("field[name^=LED]")).forEach(function(e){var r=e.getAttribute("name"),t=parseInt(r[3]),n=parseInt(r[4]);o[n][t]="TRUE"==e.innerHTML?"#":"."}),e.innerHTML="";var r=e.ownerDocument.createElement("field");r.setAttribute("name","LEDS");var t="`\n"+o.map(function(e){return e.join("")}).join("\n")+"\n`";r.appendChild(e.ownerDocument.createTextNode(t)),e.appendChild(r)});var o={};g.U.toArray(r.querySelectorAll("variable")).forEach(function(e){return o[e.innerHTML]=e.getAttribute("id")}),g.U.toArray(r.querySelectorAll("block[type=radio_on_packet]")).forEach(function(e){var r=e.querySelector("mutation");if(r){var t=JSON.parse(e.getAttribute("renamemap")||"{}");switch(r.getAttribute("callbackproperties")){case"receivedNumber":e.setAttribute("type","radio_on_number"),e.removeChild(e.querySelector("field[name=receivedNumber]")),n(e,t,"receivedNumber");break;case"receivedString,receivedNumber":e.setAttribute("type","radio_on_value"),e.removeChild(e.querySelector("field[name=receivedNumber]")),e.removeChild(e.querySelector("field[name=receivedString]")),n(e,t,"name"),n(e,t,"value");break;case"receivedString":e.setAttribute("type","radio_on_string"),e.removeChild(e.querySelector("field[name=receivedString]")),n(e,t,"receivedString")}e.removeChild(r)}})}function n(e,r,t){var n=e.ownerDocument.createElement("field");n.setAttribute("name","HANDLER_"+t),n.setAttribute("id",o[r[t]||t]),n.appendChild(e.ownerDocument.createTextNode(t)),e.appendChild(n)}}e.bufferConcat=function(e){for(var r=0,t=0,n=e;t<n.length;t++){r+=(c=n[t]).length}for(var o=new Uint8Array(r),i=r=0,a=e;i<a.length;i++){var c=a[i];o.set(c,r),r+=c.length}return o},e.deployCoreAsync=u,e.initExtensionsAsync=function(e){g.debug("loading microbit target extensions..."),Math.imul||(Math.imul=function(e,r){var t=65535&e,n=65535&r;return t*n+((e>>>16&65535)*n+t*(r>>>16&65535)<<16>>>0)|0});var r={hexFileImporters:[{id:"blockly",canImport:function(e){return"microbit.co.uk"==e.meta.cloudId&&"blockly"==e.meta.editor},importAsync:function(e,r){return e.createProjectAsync({filesOverride:{"main.blocks":r.source},name:r.meta.name})}}]};return g.usb.setFilters([{vendorId:3368,productId:516,classCode:255,subclassCode:3}]),c()&&(g.commands.deployCoreAsync=u),r.blocklyPatch=p,Promise.resolve(r)}}(g.editor||(g.editor={}))}(pxt||(pxt={}));