var pxt;!function(a){var e;(e=a.winrt||(a.winrt={})).driveDeployCoreAsync=function(e){var n=a.appTarget.compile.deployDrives;a.Util.assert(!!n),a.debug("deploying to drives "+n);var t=new RegExp(n),r=a.outputName(),i=e.outfiles[r];function o(n){return a.debug("writing "+r+" to "+n.displayName),a.winrt.promisify(n.createFileAsync(r,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,i)})).then(function(e){}).catch(function(e){a.debug("failed to write "+r+" to "+n.displayName+" - "+e)})}return a.winrt.promisify(Windows.Storage.KnownFolders.removableDevices.getFoldersAsync()).then(function(e){var n=e.filter(function(e){return t.test(e.displayName)}).map(o);return Promise.join.apply(Promise,n)}).then(function(e){})},e.browserDownloadAsync=function(n,e,t){var r;return a.winrt.promisify(Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(r=e,n)}).then(function(){return Windows.System.Launcher.launchFileAsync(r)}).then(function(e){}))},e.saveOnlyAsync=function(r){var i=a.appTarget.compile.useUF2,e=i?[".uf2"]:[".hex"],n=new Windows.Storage.Pickers.FileSavePicker;return n.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,n.fileTypeChoices.insert("MakeCode binary file",e),n.suggestedFileName=r.downloadFileBaseName,a.winrt.promisify(n.pickSaveFileAsync().then(function(e){if(e){var n=i?r.outfiles[pxtc.BINARY_UF2]:r.outfiles[pxtc.BINARY_HEX],t=[];return a.Util.stringToUint8Array(atob(n)).forEach(function(e){return t.push(e)}),Windows.Storage.FileIO.writeBytesAsync(e,t).then(function(){return!0})}return Promise.resolve(!1)}))}}(pxt||(pxt={})),function(l){!function(c){var e=function(){function e(){this.onData=function(e){},this.onEvent=function(e){},this.onError=function(e){}}return e.prototype.error=function(e){throw new Error(l.U.lf("USB/HID error ({0})",e))},e.prototype.reconnectAsync=function(){var e=this;return this.disconnectAsync().then(function(){return e.initAsync()})},e.prototype.isSwitchingToBootloader=function(){n()},e.prototype.disconnectAsync=function(){if(this.dev){var e=this.dev;delete this.dev,e.close()}return Promise.resolve()},e.prototype.sendPacketAsync=function(e){if(!this.dev)return Promise.resolve();for(var n=[0],t=0;t<Math.max(e.length,64);++t)n.push(e[t]||0);var r=new Windows.Storage.Streams.DataWriter;r.writeBytes(n);var i=r.detachBuffer(),o=this.dev.createOutputReport(0);return o.data=i,l.winrt.promisify(this.dev.sendOutputReportAsync(o).then(function(e){l.debug("hf2: "+e+" bytes written")}))},e.prototype.initAsync=function(n){var r=this;void 0===n&&(n=!1),l.Util.assert(!this.dev,"HID interface not properly reseted");var t,i=Windows.Devices,o=i.HumanInterfaceDevice.HidDevice,a=function(){var e=new Error(l.U.lf("Device not found"));return e.notifyUser=!0,e.type="devicenotfound",Promise.reject(e)};return s.reduce(function(e,n){return e.then(function(e){return e&&e.length?Promise.resolve(e):i.Enumeration.DeviceInformation.findAllAsync(n,null)})},Promise.resolve(null)).then(function(e){if(!e||!e[0])return l.debug("no hid device found"),Promise.reject(new Error("no hid device found"));l.debug("hid enumerate "+e.length+" devices");var n=e[0];return l.debug("hid connect to "+n.name+" ("+n.id+")"),t=n.id,o.fromIdAsync(n.id,Windows.Storage.FileAccessMode.readWrite)}).then(function(e){if(r.dev=e,!r.dev){l.debug("can't connect to hid device");var n=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(t).currentStatus;return l.reportError("winrt_device","could not connect to HID device; device status: "+n),Promise.reject(new Error("can't connect to hid device"))}return l.debug("hid device version "+r.dev.version),r.dev.addEventListener("inputreportreceived",function(e){l.debug("input report");for(var n=Windows.Storage.Streams.DataReader.fromBuffer(e.report.data),t=[];n.unconsumedBufferLength;)t.push(n.readByte());65==t.length&&0===t[0]&&t.shift(),r.onData(new Uint8Array(t))}),Promise.resolve()}).catch(function(e){return n?a():c.bootloaderViaBaud().then(function(){return r.initAsync(!0)}).catch(function(){return a()})})},e}();function n(){d=!0,c.packetIO&&c.packetIO.dev&&(f=!0)}c.WindowsRuntimeIO=e,c.packetIO=void 0,c.mkPacketIOAsync=function(){return l.U.assert(!c.packetIO),c.packetIO=new e,c.packetIO.initAsync().catch(function(e){return c.packetIO=null,Promise.reject(e)}).then(function(){return c.packetIO})},c.isSwitchingToBootloader=n;var s=[],a=[],u=0,d=!1,f=!1;c.initWinrtHid=function(t,r){var e=Windows.Devices,i=Windows.Devices.Enumeration.DeviceInformation,o=e.HumanInterfaceDevice.HidDevice;l.appTarget&&l.appTarget.compile&&l.appTarget.compile.hidSelectors&&l.appTarget.compile.hidSelectors.forEach(function(e){var n=o.getDeviceSelector(parseInt(e.usagePage),parseInt(e.usageId),parseInt(e.vid),parseInt(e.pid));s.push(n)}),s.forEach(function(e){var n=i.createWatcher(e,null);n.addEventListener("added",function(e){l.debug("new hid device detected: "+e.id),d?d=!1:1==++u&&t&&t()}),n.addEventListener("removed",function(e){l.debug("hid device closed: "+e.id),f?f=!1:0<--u&&t?t():0===u&&r&&r()}),n.addEventListener("updated",function(e){}),a.push(n)}),a.forEach(function(e){return e.start()})}}(l.winrt||(l.winrt={}))}(pxt||(pxt={})),function(d){!function(t){var r,i,u={};function o(e){if(!e)return Promise.resolve([]);var n=Windows.Devices,t=n.SerialCommunication.SerialDevice,r=n.Enumeration.DeviceInformation,i=[];return e.forEach(function(e){var n=t.getDeviceSelectorFromUsbVidPid(parseInt(e.vid),parseInt(e.pid));i.push(n)}),i.reduce(function(e,n){var t;return e.then(function(e){return t=e,r.findAllAsync(n,null)}).then(function(e){if(t)for(var n=0;n<e.length;++n)t.push(e[n]);else t=e;return Promise.resolve(t)})},Promise.resolve(null)).then(function(e){return e?Promise.map(e,function(e){return t.fromIdAsync(e.id)}):Promise.resolve([])})}function a(n){i&&!i.test(n.name)||(d.debug("serial port added "+n.name+" - "+n.id),u[n.id]={info:n},Windows.Devices.SerialCommunication.SerialDevice.fromIdAsync(n.id).done(function(e){u[n.id].device=e,function t(r){var i=u[r];if(!i)return;if(!i.device){var e=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(r).currentStatus;return void d.reportError("winrt_device","could not connect to serial device; device status: "+e)}var n=Windows.Storage.Streams;i.device.baudRate=115200;var o=i.device.inputStream;var a=new n.DataReader(o);a.inputStreamOptions=n.InputStreamOptions.partial;var c={};var s=function(){u[r]&&!i.cancellingDeferred&&(i.readingOperation=a.loadAsync(32),i.readingOperation.done(function(e){var n=a.readString(4*Math.floor(a.unconsumedBufferLength/4));d.Util.bufferSerial(c,n,r),setTimeout(function(){return s()},1)},function(e){var n=i.readingOperation.operation.status;n===Windows.Foundation.AsyncStatus.canceled?(a.detachStream(),a.close(),i.cancellingDeferred&&setTimeout(function(){return i.cancellingDeferred.resolve()},25)):setTimeout(function(){return t(r)},1e3)}))};setTimeout(function(){return s()},100)}(n.id)}))}function c(e){delete u[e.id]}function s(e){var n=u[e.id];n&&n.info.update(e)}t.initSerial=function(){var e=!(!d.appTarget.serial||!(d.appTarget.serial.nameFilter||d.appTarget.serial.vendorId&&d.appTarget.serial.productId));if(d.appTarget.serial&&d.appTarget.serial.log&&e){var n,t=Windows.Devices.SerialCommunication.SerialDevice;d.appTarget.serial.vendorId&&d.appTarget.serial.productId?n=t.getDeviceSelectorFromUsbVidPid(parseInt(d.appTarget.serial.vendorId),parseInt(d.appTarget.serial.productId)):(i=new RegExp(d.appTarget.serial.nameFilter),n=t.getDeviceSelector()),(r=Windows.Devices.Enumeration.DeviceInformation.createWatcher(n,null)).addEventListener("added",a),r.addEventListener("removed",c),r.addEventListener("updated",s),r.start()}},t.suspendSerialAsync=function(){r&&(r.stop(),r.removeEventListener("added",a),r.removeEventListener("removed",c),r.removeEventListener("updated",s),r=void 0);var i=Promise.resolve();return Object.keys(u).forEach(function(e){var n=u[e],t=n.readingOperation;if(t){var r=Promise.defer();n.cancellingDeferred=r,i=i.then(function(){return r.promise.timeout(500).catch(function(e){d.reportError("winrt_device","could not cancel reading operation for a device: "+e.message)})}),t.cancel()}}),i.then(function(){Object.keys(u).forEach(function(e){var n=u[e];n.device&&n.device.close()}),u={}})},t.bootloaderViaBaud=function(){if(!(d.appTarget&&d.appTarget.compile&&d.appTarget.compile.useUF2&&d.appTarget.simulator&&d.appTarget.simulator.boardDefinition&&d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo))return Promise.reject(new Error("device does not support switching to bootloader via baudrate"));var n,e=d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo;return o([{vid:e.vid,pid:e.pid,usageId:void 0,usagePage:void 0}]).then(function(e){return e&&0!==e.length?((n=e).length&&t.isSwitchingToBootloader(),n.forEach(function(e){e.baudRate=1200,e.close()}),Promise.delay(1500)):Promise.reject(new Error("no serial devices to switch into bootloader"))})},t.connectSerialDevicesAsync=o}(d.winrt||(d.winrt={}))}(pxt||(pxt={})),function(l){!function(i){function o(){return"undefined"!=typeof Windows}function a(){return o()?(n.resolve(null),n.promise.then(function(e){return Promise.resolve(e&&e.kind===Windows.ApplicationModel.Activation.ActivationKind.file)})):Promise.resolve(!1)}function t(){return o()?Promise.resolve().then(function(){return i.packetIO?(l.log("disconnecting packetIO"),i.packetIO.disconnectAsync()):Promise.resolve()}).catch(function(e){e.message="error disconnecting packetIO: "+e.message,l.reportException(e)}).then(function(){return l.log("suspending serial"),i.suspendSerialAsync()}).catch(function(e){e.message="error suspending serial: "+e.message,l.reportException(e)}):Promise.resolve()}function c(e){Windows.UI.WebUI.WebUIApplication.removeEventListener("activated",c),n.resolve(e)}function s(e){l.log("suspending");var n=e.suspendingOperation.getDeferral();return t().then(function(){return n.complete()},function(e){return n.complete()}).done()}function u(e){l.log("resuming"),i.packetIO&&(l.log("reconnet pack io"),i.packetIO.reconnectAsync().done()),i.initSerial()}var n,d;function f(e,n){if(void 0===n&&(n=!1),e.kind===Windows.ApplicationModel.Activation.ActivationKind.file){var t=e.files.getAt(0);if(t&&t.isOfType(Windows.Storage.StorageItemTypes.file)){var r=t;Windows.Storage.FileIO.readBufferAsync(r).then(function(e){for(var n=[],t=Windows.Storage.Streams.DataReader.fromBuffer(e);t.unconsumedBufferLength;)n.push(t.readByte());return t.close(),l.cpp.unpackSourceFromHexAsync(new Uint8Array(n))}).then(function(e){return d(e,n)})}}}i.promisify=function(e){return new Promise(function(n,t){e.done(function(e){return n(e)},function(e){return t(e)})})},i.toArray=function(e){for(var n=[],t=e.length,r=0;r<t;++r)n.push(e[r]);return n},i.isWindows=function(){return!!navigator&&/Win32/i.test(navigator.platform)},i.isWinRT=o,i.initAsync=function(e){if(!o()||l.BrowserUtils.isIFrame())return Promise.resolve();var n=Windows.UI.Core,t=n.SystemNavigationManager.getForCurrentView(),r=Windows.UI.WebUI.WebUIApplication;return r.addEventListener("suspending",s),r.addEventListener("resuming",u),t.onbackrequested=function(e){l.log("BACK NAVIGATION"),t.appViewBackButtonVisibility=n.AppViewBackButtonVisibility.collapsed,e.handled=!0},i.initSerial(),a().then(function(){e&&(d=e,r.removeEventListener("activated",c),r.addEventListener("activated",f))})},i.captureInitialActivation=function(){o()&&(n=Promise.defer(),Windows.UI.WebUI.WebUIApplication.addEventListener("activated",c))},i.loadActivationProject=function(){return n.promise.then(function(e){return f(e,!0)})},i.hasActivationProjectAsync=a,i.releaseAllDevicesAsync=t}(l.winrt||(l.winrt={}))}(pxt||(pxt={})),function(w){var y;(function(e){var d,a,c,f=w.Util,s=[];function l(n){return s.filter(function(e){return e.id==n})[0]}function p(e){var n=l(e.path);n||(n={id:e.path,header:null,text:null,fsText:null},s.push(n));var t=e.files.map(function(e){return e.mtime});t.sort(function(e,n){return n-e});var r=Math.round(t[0]/1e3)||f.nowSeconds(),i={target:a,targetVersion:n.header?n.header.targetVersion:c,name:e.config.name,meta:{},editor:w.JAVASCRIPT_PROJECT_NAME,pubId:e.config.installedVersion,pubCurrent:!1,_rev:null,id:e.path,recentUse:r,modificationTime:r,blobId:null,blobCurrent:!1,isDeleted:!1,icon:e.icon};if(n.header){var o=n.header;o.name=i.name,o.pubId=i.pubId,o.modificationTime=i.modificationTime,o.isDeleted=i.isDeleted,o.icon=i.icon}else n.header=i}var t=new f.PromiseQueue;function u(c,s){if(c.temporary)return Promise.resolve();var u=l(c.id);return f.assert(u.header===c),s?(c.saveId=null,u.textNeedsSave=!0,u.text=s,t.enqueue(c.id,function(){f.assert(!!u.fsText);for(var e={files:[],config:null,path:c.id},n=0,t=Object.keys(u.text);n<t.length;n++){var r=t[n];u.text[r]!==u.fsText[r]&&e.files.push({name:r,mtime:null,content:u.text[r],prevContent:u.fsText[r]})}var o,i,a=f.flatClone(u.text);return 0==e.files.length?Promise.resolve():(o=c.id,i=e,w.debug("winrt: writing package at "+o),y.promisify(d.createFolderAsync(o,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(){return Promise.map(i.files,function(n){return m(v(o,n.name)).then(function(e){if(n.name==w.CONFIG_NAME)try{JSON.parse(n.content).name||(w.log("Trying to save invalid JSON config"),g(410))}catch(e){w.log("Trying to save invalid format JSON config"),g(410)}e!==n.prevContent&&(w.log("merge error for "+n.name+": previous content changed..."),g(409))},function(e){})})}).then(function(){return Promise.map(i.files,function(e){return n=o,t=e.name,r=e.content,i=v(d.path,n),w.debug("winrt: writing "+v(i,t)),y.promisify(Windows.Storage.StorageFolder.getFolderFromPathAsync(i)).then(function(e){return e.createFileAsync(t,Windows.Storage.CreationCollisionOption.replaceExisting)}).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,r)}).then(function(){});var n,t,r,i})}).then(function(){return h(o,!1)})).then(function(e){u.fsText=a,p(e),s&&(c.saveId=null)})})):Promise.resolve()}function v(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return e.join("\\")}function m(e){var n=v(d.path,e);return w.debug("winrt: reading "+n),y.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(n).then(function(e){return Windows.Storage.FileIO.readTextAsync(e)}))}function g(e,n){void 0===n&&(n=null);var t=new Error(n||"Error "+e);throw t.statusCode=e,t}function h(r,i){return w.debug("winrt: reading package under "+r),m(v(r,w.CONFIG_NAME)).then(function(e){var n=JSON.parse(e),t=[w.CONFIG_NAME].concat(n.files||[]).concat(n.testFiles||[]);return Promise.map(t,function(t){return(n=v(r,t),e=v(d.path,n),w.debug("winrt: "+e),y.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(e).then(function(e){return e.getBasicPropertiesAsync().then(function(e){return{name:n,mtime:e.dateModified.getTime()}})}))).then(function(e){var n={name:t,mtime:e?e.mtime:null};return null!=e&&i?m(v(r,t)).then(function(e){return n.content=e,n}):n});var n,e}).then(function(e){return{path:r,config:n,files:e}})})}function r(){return y.promisify(d.getFoldersAsync()).then(function(e){return Promise.all(e.map(function(e){return h(e.name,!1)}))}).then(function(e){e.forEach(p)})}e.provider={getHeaders:function(){return s.map(function(e){return e.header})},getHeader:function(e){var n=l(e);return n&&!n.header.isDeleted?n.header:null},getTextAsync:function(e){w.debug("winrt: get text "+e);var n=l(e);return n?n.text?Promise.resolve(n.text):t.enqueue(e,function(){return i=n,w.debug("winrt: fetch "+i.id),h(i.id,!0).then(function(e){if(!i.text){i.text={};for(var n=i.mtime=0,t=e.files;n<t.length;n++){var r=t[n];i.text[r.name]=r.content,i.mtime=Math.max(i.mtime,r.mtime)}i.fsText=f.flatClone(i.text)}return i.text});var i}):Promise.resolve(null)},initAsync:function(e,n){s=[],a=e,c=n;var t=Windows.Storage.ApplicationData.current.localFolder;return w.debug("winrt: initializing workspace"),y.promisify(t.createFolderAsync(a,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(e){return d=e,w.debug("winrt: initialized workspace at "+d.path),r()}).then(function(){})},saveAsync:function(e,n){return u(e,n)},installAsync:function(e,n){var t=e,r=t.name.replace(/[^a-zA-Z0-9]+/g," ").trim().replace(/ /g,"-");if(l(r)){for(var i=2;l(r+"-"+i);)i++;r+="-"+i,t.name+=" "+i}t.id=r,t.recentUse=f.nowSeconds(),t.modificationTime=t.recentUse;var o={id:t.id,header:t,text:n,fsText:{}};return s.push(o),u(t,n).then(function(){return t})},saveToCloudAsync:function(e){return Promise.resolve()},syncAsync:r,resetAsync:function(){return y.promisify(d.deleteAsync(Windows.Storage.StorageDeleteOption.default).then(function(){d=void 0,s=[],w.storage.clearLocal()}))},loadedAsync:function(){return Promise.resolve()}}})((y=w.winrt||(w.winrt={})).workspace||(y.workspace={}))}(pxt||(pxt={}));